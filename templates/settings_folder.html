{% extends "base.html" %}

{% block content %}
<div class="container pb-5">
    
    <div class="row align-items-center mb-4 mt-2">
        
        <div class="col overflow-hidden">
            <h4 class="fw-bold text-dark m-0 text-truncate">Konfigurasi Tahun</h4>
            <span class="badge bg-light text-secondary border rounded-pill mt-1 px-3 text-truncate d-inline-block" style="max-width: 100%;">
                {{ folder.name }}
            </span>
        </div>

        <div class="col-auto">
            <div style="width: 45px; height: 45px; flex: 0 0 45px;">
                {% if request.args.get('origin') == 'list' %}
                    <a href="{{ url_for('select_year') }}" 
                       class="btn btn-white bg-white shadow-sm border rounded-circle hover-scale p-0 d-flex align-items-center justify-content-center" 
                       style="width: 100%; height: 100%;" 
                       title="Kembali ke Daftar Tahun">
                        <i class="bi bi-arrow-left text-dark fs-5"></i>
                    </a>
                {% else %}
                    <a href="{{ url_for('dashboard', folder_id=folder.id) }}" 
                       class="btn btn-white bg-white shadow-sm border rounded-circle hover-scale p-0 d-flex align-items-center justify-content-center" 
                       style="width: 100%; height: 100%;" 
                       title="Kembali ke Dashboard">
                        <i class="bi bi-arrow-left text-dark fs-5"></i>
                    </a>
                {% endif %}
            </div>
        </div>

    </div>
    <form method="POST" class="mb-5">
        
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 px-4">
                <h6 class="fw-bold text-primary mb-0"><i class="bi bi-gear-fill me-2"></i>Informasi Umum</h6>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">NAMA TAHUN / LABEL</label>
                        <input type="text" name="name" class="form-control form-control-auth" value="{{ folder.name }}" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">URL SPREADSHEET</label>
                        <input type="url" name="url" class="form-control form-control-auth" value="{{ folder.spreadsheet_url }}" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label small fw-bold text-muted">SHEET BULANAN (PISAH DENGAN KOMA)</label>
                        <input type="text" name="sheet_list" class="form-control form-control-auth" value="{{ folder.sheet_list_str }}" placeholder="Januari, Februari, Maret">
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 px-4">
                <h6 class="fw-bold text-warning mb-0"><i class="bi bi-wallet2 me-2"></i>Mapping Cell Total (KPI)</h6>
            </div>
            <div class="card-body p-4">
                
                <div class="bg-light p-3 rounded-4 mb-4 border">
                    <h6 class="small fw-bold text-dark mb-3"><i class="bi bi-cash-stack me-1"></i> DANA KOTOR (Dari Rumus Excel)</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Cell Pemasukan</label>
                            <div class="input-group">
                                <span class="input-group-text bg-success bg-opacity-10 text-success border-0"><i class="bi bi-arrow-down-left"></i></span>
                                <input type="text" name="cell_addr_income" class="form-control form-control-auth" value="{{ folder.cell_addr_income }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Cell Pengeluaran</label>
                            <div class="input-group">
                                <span class="input-group-text bg-danger bg-opacity-10 text-danger border-0"><i class="bi bi-arrow-up-right"></i></span>
                                <input type="text" name="cell_addr_expense" class="form-control form-control-auth" value="{{ folder.cell_addr_expense }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Cell Sisa Saldo</label>
                            <div class="input-group">
                                <span class="input-group-text bg-primary bg-opacity-10 text-primary border-0"><i class="bi bi-wallet"></i></span>
                                <input type="text" name="cell_addr_balance" class="form-control form-control-auth" value="{{ folder.cell_addr_balance }}">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-light p-3 rounded-4 border">
                    <h6 class="small fw-bold text-dark mb-3"><i class="bi bi-stars me-1"></i> DANA BERSIH (Operasional Murni)</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small text-muted">List Cell Pemasukan (Pisah Koma)</label>
                            <input type="text" name="clean_income_cells" class="form-control form-control-auth" value="{{ folder.clean_income_cells }}" placeholder="Contoh: Z1, Z5">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small text-muted">List Cell Pengeluaran (Pisah Koma)</label>
                            <input type="text" name="clean_expense_cells" class="form-control form-control-auth" value="{{ folder.clean_expense_cells }}" placeholder="Contoh: Z2, Z6">
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 pt-4 px-4">
                <h6 class="fw-bold text-info mb-0"><i class="bi bi-graph-up me-2"></i>Konfigurasi Grafik Trend</h6>
            </div>
            <div class="card-body p-4">
                <div class="row g-3 mb-3">
                    <div class="col-12">
                        <label class="form-label small fw-bold text-muted">HEADER KOLOM TANGGAL</label>
                        <input type="text" name="col_date" class="form-control form-control-auth" value="{{ folder.col_date }}">
                    </div>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">HEADER NOMINAL PEMASUKAN</label>
                        <input type="text" name="col_income" class="form-control form-control-auth" value="{{ folder.col_income }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">HEADER NOMINAL PENGELUARAN</label>
                        <input type="text" name="col_expense" class="form-control form-control-auth" value="{{ folder.col_expense }}">
                    </div>
                </div>

                <div class="alert alert-light border rounded-3 p-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-funnel-fill text-secondary me-2"></i>
                        <span class="fw-bold text-dark small">Filter Hutang (Grafik Bersih)</span>
                    </div>
                    <p class="text-muted small mb-3">
                        Grafik akan mengabaikan transaksi jika kategori mengandung kata kunci di bawah ini.
                    </p>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input type="text" name="col_source_income" class="form-control form-control-auth form-control-sm" value="{{ folder.col_source_income }}" placeholder="Header Kategori Masuk">
                        </div>
                        <div class="col-md-4">
                            <input type="text" name="col_source_expense" class="form-control form-control-auth form-control-sm" value="{{ folder.col_source_expense }}" placeholder="Header Kategori Keluar">
                        </div>
                        <div class="col-md-4">
                            <input type="text" name="debt_keywords" class="form-control form-control-auth form-control-sm" value="{{ folder.debt_keywords }}" placeholder="Keyword: Hutang, Pindahan">
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-white border-0 px-4 pb-4 pt-0">
                <button type="submit" class="btn btn-dark w-100 rounded-pill fw-bold py-2 shadow-sm">
                    <i class="bi bi-check-lg me-2"></i> Simpan Semua Konfigurasi
                </button>
            </div>
        </div>
    </form>

    <h5 class="fw-bold text-dark mb-3 px-1">Mapping Kategori (Pie Chart)</h5>
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm card-soft-success">
                <div class="card-header border-0 bg-transparent fw-bold text-success pt-4 px-4">
                    <i class="bi bi-arrow-down-circle-fill me-2"></i> Kategori Pemasukan
                </div>
                <div class="card-body px-4">
                    <div class="table-responsive bg-white rounded-4 p-2 shadow-sm mb-3">
                        <table class="table table-borderless table-sm align-middle mb-0">
                            <thead class="text-muted small border-bottom">
                                <tr><th class="ps-3">Nama</th><th>Cell</th><th>Bersih?</th><th></th></tr>
                            </thead>
                            <tbody>
                                {% for cat in cats_income %}
                                <tr>
                                    <td class="ps-3 fw-bold">{{ cat.name }}</td>
                                    <td class="font-monospace small">{{ cat.cell_addr }}</td>
                                    <td>{% if cat.is_clean %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    <td class="text-end pe-3"><a href="{{ url_for('delete_category', cat_id=cat.id) }}" class="text-danger"><i class="bi bi-trash"></i></a></td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-center text-muted small py-3">Belum ada kategori</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <form action="{{ url_for('add_category', folder_id=folder.id) }}" method="POST" class="bg-white p-3 rounded-4 shadow-sm">
                        <input type="hidden" name="cat_type" value="income">
                        <h6 class="small fw-bold text-muted mb-2">TAMBAH BARU</h6>
                        <div class="row g-2 mb-2">
                            <div class="col-7"><input type="text" name="cat_name" class="form-control form-control-sm bg-light border-0" placeholder="Nama Kategori" required></div>
                            <div class="col-5"><input type="text" name="cat_addr" class="form-control form-control-sm bg-light border-0" placeholder="Cell (A1)" required></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_clean" id="chkInc">
                                <label class="form-check-label small text-muted" for="chkInc">Dana Bersih?</label>
                            </div>
                            <button class="btn btn-sm btn-success rounded-pill px-3 fw-bold">Add</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm card-soft-danger">
                <div class="card-header border-0 bg-transparent fw-bold text-danger pt-4 px-4">
                    <i class="bi bi-arrow-up-circle-fill me-2"></i> Kategori Pengeluaran
                </div>
                <div class="card-body px-4">
                    <div class="table-responsive bg-white rounded-4 p-2 shadow-sm mb-3">
                        <table class="table table-borderless table-sm align-middle mb-0">
                            <thead class="text-muted small border-bottom">
                                <tr><th class="ps-3">Nama</th><th>Cell</th><th>Bersih?</th><th></th></tr>
                            </thead>
                            <tbody>
                                {% for cat in cats_expense %}
                                <tr>
                                    <td class="ps-3 fw-bold">{{ cat.name }}</td>
                                    <td class="font-monospace small">{{ cat.cell_addr }}</td>
                                    <td>{% if cat.is_clean %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    <td class="text-end pe-3"><a href="{{ url_for('delete_category', cat_id=cat.id) }}" class="text-danger"><i class="bi bi-trash"></i></a></td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-center text-muted small py-3">Belum ada kategori</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <form action="{{ url_for('add_category', folder_id=folder.id) }}" method="POST" class="bg-white p-3 rounded-4 shadow-sm">
                        <input type="hidden" name="cat_type" value="expense">
                        <h6 class="small fw-bold text-muted mb-2">TAMBAH BARU</h6>
                        <div class="row g-2 mb-2">
                            <div class="col-7"><input type="text" name="cat_name" class="form-control form-control-sm bg-light border-0" placeholder="Nama Kategori" required></div>
                            <div class="col-5"><input type="text" name="cat_addr" class="form-control form-control-sm bg-light border-0" placeholder="Cell (A1)" required></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_clean" id="chkExp">
                                <label class="form-check-label small text-muted" for="chkExp">Dana Bersih?</label>
                            </div>
                            <button class="btn btn-sm btn-danger rounded-pill px-3 fw-bold">Add</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}